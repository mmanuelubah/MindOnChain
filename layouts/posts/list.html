{{ define "main" }}
<main class="posts-page">

  <!-- ================= SEARCH BAR ================= -->
  <div class="search-container">
    <input type="text" id="searchInput" placeholder="Search by title" class="search-input">
  </div>

  <!-- ================= TAG/CATEGORY FILTERS ================= -->
  <div class="filters-container">
    {{ $allTags := .Site.Taxonomies.tags }}
    {{ range $tag, $pages := $allTags }}
      <span class="filter-item" data-filter="{{ $tag }}" data-type="tag">#{{ $tag }}</span>
    {{ end }}

    {{ $allCategories := .Site.Taxonomies.categories }}
    {{ range $cat, $pages := $allCategories }}
      <span class="filter-item" data-filter="{{ $cat }}" data-type="category">#{{ $cat }}</span>
    {{ end }}

    <button id="clearFilters" class="clear-filters">Clear Filters</button>
  </div>

  <!-- ================= POSTS LIST BY YEAR ================= -->
  {{ $pages := .Pages.ByDate.Reverse }}
  {{ $currentYear := 0 }}
  <ul class="posts-list">
    {{ range $pages }}
      {{ $yr := .Date.Year }}
      {{ if ne $yr $currentYear }}
        {{ if ne $currentYear 0 }}</ul>{{ end }}
        <h2 class="year-heading">{{ $yr }}</h2>
        <ul class="posts-list">
        {{ $currentYear = $yr }}
      {{ end }}

      <li class="post-item"
          data-tags="{{ if .Params.tags }}{{ delimit .Params.tags " " }}{{ end }}"
          data-categories="{{ if .Params.categories }}{{ delimit .Params.categories " " }}{{ end }}">

        {{/* POST TITLE FORMATTING */}}
        {{ if in .Params.tags "weekly-roundup" }}
          {{ $week := .Params.week }}
          <a href="{{ .RelPermalink }}" class="post-link">
            Week {{ $week }} • {{ .Date.Format "January 2006" }}
          </a>
        {{ else }}
          <a href="{{ .RelPermalink }}" class="post-link">{{ .Title }}</a>
        {{ end }}

        {{/* METADATA */}}
        <div class="post-meta">
          {{ .Date.Format "Jan 2 2006" }} •
          {{ if .Params.tags }}
            {{ range .Params.tags }}
              <span class="meta-tag">#{{ . }}</span>
            {{ end }}
          {{ end }}
        </div>
      </li>
    {{ end }}
  </ul>

</main>

<!-- ================= STYLE ================= -->
<style>
.posts-page {
  max-width: 900px;
  margin: auto;
  padding: 2rem 1.5rem;
  font-family: "Ubuntu", sans-serif;
  color: #ccc;
}

/* Pixel font for titles */
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
.post-link {
  font-family: 'Press Start 2P', monospace;
  font-size: 0.85rem;
  text-decoration: none;
  color: #fff;
}

/* Post metadata */
.post-meta {
  font-family: sans-serif;
  font-size: 0.75rem;
  margin-top: 0.3rem;
  display: flex;
  flex-wrap: wrap;
  gap: 0.3rem;
  color: #a8ffa8;
}

.meta-tag {
  background-color: rgba(255,255,255,0.08);
  padding: 0.1rem 0.3rem;
  border-radius: 4px;
  color: #ccc;
}

/* Search bar */
.search-container {
  margin-bottom: 1.5rem;
}

.search-input {
  width: 100%;
  padding: 0.8rem 1rem;
  font-size: 1rem;
  border-radius: 12px;
  border: 1px solid #444;
  background-color: #1b1b1b;
  color: #fff;
  outline: none;
}

/* Filter items */
.filters-container {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 2rem;
  align-items: center;
}

.filter-item {
  cursor: pointer;
  background-color: rgba(255,255,255,0.08);
  color: #ccc;
  padding: 0.3rem 0.6rem;
  border-radius: 6px;
  font-size: 0.75rem;
  transition: all 0.2s;
}

.filter-item:hover {
  background-color: rgba(0,255,0,0.15);
  color: #0f0;
}

.filter-item.active {
  background-color: rgba(0,255,0,0.3);
  color: #0f0;
}

/* Clear filters button */
.clear-filters {
  margin-left: 1rem;
  cursor: pointer;
  padding: 0.3rem 0.6rem;
  border-radius: 6px;
  background-color: rgba(255,0,0,0.2);
  border: none;
  color: #fff;
}

/* Year headings */
.year-heading {
  margin-top: 2rem;
  font-size: 1.2rem;
  border-bottom: 1px solid #555;
  padding-bottom: 0.3rem;
  color: #fff;
}

/* Posts list */
.posts-list {
  list-style: none;
  padding: 0;
  margin: 0.5rem 0 1.5rem;
}

.post-item {
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid #444;
}
</style>

<!-- ================= SCRIPT ================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const searchInput = document.getElementById("searchInput");
  const posts = document.querySelectorAll(".post-item");
  const filters = document.querySelectorAll(".filter-item");
  const clearBtn = document.getElementById("clearFilters");

  let activeFilters = new Set();

  function updatePosts() {
    const query = searchInput.value.toLowerCase();
    posts.forEach(post => {
      const title = post.querySelector(".post-link").textContent.toLowerCase();
      const postTags = post.dataset.tags ? post.dataset.tags.split(" ") : [];
      const postCategories = post.dataset.categories ? post.dataset.categories.split(" ") : [];
      const hasFilter = activeFilters.size === 0 || [...activeFilters].some(f => postTags.includes(f) || postCategories.includes(f));
      post.style.display = (title.includes(query) && hasFilter) ? "" : "none";
    });
  }

  // Search input
  searchInput.addEventListener("input", updatePosts);

  // Filters click
  filters.forEach(filter => {
    filter.addEventListener("click", () => {
      const name = filter.dataset.filter;
      if (filter.classList.contains("active")) {
        filter.classList.remove("active");
        activeFilters.delete(name);
      } else {
        filter.classList.add("active");
        activeFilters.add(name);
      }
      updatePosts();
    });
  });

  // Clear filters button
  clearBtn.addEventListener("click", () => {
    activeFilters.clear();
    filters.forEach(f => f.classList.remove("active"));
    updatePosts();
  });
});
</script>
{{ end }}
