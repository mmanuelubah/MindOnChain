{{ define "main" }}
<main style="padding:1.5rem 2rem;">

  <!-- ================= TOP BAR: AUTHOR & SEARCH ================= -->
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
    <!-- Author -->
    <div style="display:flex; flex-direction:column; align-items:flex-start;">
      <img src="{{ .Site.Params.avatar | absURL }}" alt="Avatar"
           style="width:70px; height:70px; border-radius:50%; object-fit:cover; box-shadow:0 2px 6px rgba(0,0,0,0.2);">
      <h1 id="animated-title"
          style="font-family:'Fira Code', monospace; font-size:1rem; margin-top:8px; font-weight:700;">
        {{ .Site.Title }}
      </h1>
    </div>

    <!-- Search -->
    <div style="position:relative; width:260px;">
      <input id="searchInput" type="text" placeholder="Search (Ctrl + K)"
             style="padding:0.6rem 1rem; border-radius:8px; border:none; outline:none; width:100%; background-color:rgba(255,255,255,0.08); color:#fff;">
    </div>
  </div>

  <!-- ================= MIDDLE GRID ================= -->
  <div style="display:grid; grid-template-columns:1fr 2fr 1fr; gap:2rem; align-items:start;">

    <!-- Categories -->
    <aside>
      <h2 style="font-size:0.95rem; font-weight:600; margin-bottom:0.8rem; opacity:0.8;">Categories</h2>
      <ul style="list-style:none; padding:0; margin:0;">
        {{ with .Site.Taxonomies.categories }}
          {{ range first 10 (sort . "Count" "desc") }}
          <li style="margin-bottom:0.5rem;">
            <a href="{{ .Page.Permalink }}"
               style="color:#ccc; text-decoration:none; font-size:0.9rem;">• {{ .Page.Title }}</a>
          </li>
          {{ end }}
        {{ else }}
          <li style="color:gray; font-size:0.85rem;">No categories yet.</li>
        {{ end }}
      </ul>
    </aside>

    <!-- Recent Posts -->
    <section class="recent-posts" style="text-align:left;">
      <h2 style="font-size:0.95rem; font-weight:600; margin-bottom:1rem; opacity:0.8;">Recent Posts</h2>
      <ul id="postList" style="list-style:none; padding:0;">
        {{ range first 10 (where .Site.RegularPages "Type" "posts") }}
        <li style="margin-bottom:1rem;">
          <a href="{{ .RelPermalink }}"
             style="font-size:1rem; font-weight:600; text-decoration:none; color:#fff;">
            {{ .Title }}
          </a><br>
          <small style="font-size:0.85rem; color:gray;">
            {{ .Date.Format "Jan 2, 2006" }} • {{ .ReadingTime }} min read
          </small>
        </li>
        {{ end }}
      </ul>
    </section>

    <!-- Trending Tags -->
    <aside>
      <h2 style="font-size:0.95rem; font-weight:600; margin-bottom:0.8rem; opacity:0.8;">Trending Tags</h2>
      <ul style="list-style:none; padding-left:0; margin:0;">
        {{ with .Site.Taxonomies.tags }}
          {{ range first 10 (sort . "Count" "desc") }}
          <li style="margin-bottom:0.5rem;">
            <a href="{{ .Page.Permalink }}"
               style="color:#ccc; text-decoration:none; font-size:0.9rem;">#{{ .Page.Title }}</a>
          </li>
          {{ end }}
        {{ else }}
          <li style="color:gray; font-size:0.85rem;">No tags yet.</li>
        {{ end }}
      </ul>
    </aside>

  </div>
</main>

<!-- ================= STYLE ================= -->
<style>
  :root {
    --text-dark: #111;
    --text-light: #f8f8f8;
    --glow-dark: rgba(0, 255, 204, 0.6);
    --glow-light: rgba(0, 140, 255, 0.6);
  }

  html[data-theme="light"] #animated-title {
    color: var(--text-dark);
    text-shadow: 0 0 8px var(--glow-light);
  }

  html[data-theme="dark"] #animated-title {
    color: var(--text-light);
    text-shadow: 0 0 8px var(--glow-dark);
  }

  #animated-title {
    display:inline-block;
    letter-spacing:1px;
    transition: color 0.3s, text-shadow 0.3s;
    animation: flicker 3s infinite;
  }

  @keyframes flicker {
    0%,18%,22%,25%,53%,57%,100% { opacity:1; }
    20%,24%,55% { opacity:0.4; }
  }

  .dud { opacity:0.4; }

  @media (max-width:900px) {
    main {
      display:block;
      padding:1rem;
    }
    .recent-posts, aside {
      margin-top:1.5rem;
    }
  }
</style>

<!-- ================= SCRIPTS ================= -->
<script>
  /* === Text Scramble Animation === */
  class TextScramble {
    constructor(el) {
      this.el = el;
      this.chars = "!<>-_\\/[]{}—=+*^?#________";
      this.update = this.update.bind(this);
    }
    setText(newText) {
      const oldText = this.el.innerText;
      const length = Math.max(oldText.length, newText.length);
      const promise = new Promise((resolve) => (this.resolve = resolve));
      this.queue = [];
      for (let i = 0; i < length; i++) {
        const from = oldText[i] || "";
        const to = newText[i] || "";
        const start = Math.floor(Math.random() * 40);
        const end = start + Math.floor(Math.random() * 40);
        this.queue.push({ from, to, start, end });
      }
      cancelAnimationFrame(this.frameRequest);
      this.frame = 0;
      this.update();
      return promise;
    }
    update() {
      let output = "";
      let complete = 0;
      for (let i = 0, n = this.queue.length; i < n; i++) {
        let { from, to, start, end, char } = this.queue[i];
        if (this.frame >= end) {
          complete++;
          output += to;
        } else if (this.frame >= start) {
          if (!char || Math.random() < 0.28) {
            char = this.randomChar();
            this.queue[i].char = char;
          }
          output += `<span class='dud'>${char}</span>`;
        } else {
          output += from;
        }
      }
      this.el.innerHTML = output;
      if (complete === this.queue.length) {
        this.resolve();
      } else {
        this.frameRequest = requestAnimationFrame(this.update);
        this.frame++;
      }
    }
    randomChar() {
      return this.chars[Math.floor(Math.random() * this.chars.length)];
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const el = document.getElementById("animated-title");
    const fx = new TextScramble(el);
    const phrases = ["MindOnChain", "m1nD0NCh41n", "EMM4NU3L U84H", "MindOnChain"];
    let counter = 0;
    const next = () => {
      fx.setText(phrases[counter]).then(() => setTimeout(next, 3000));
      counter = (counter + 1) % phrases.length;
    };
    next();
  });

  /* === Search Bar === */
  const searchInput = document.getElementById("searchInput");
  const posts = document.querySelectorAll("#postList li");
  searchInput.addEventListener("keyup", () => {
    const q = searchInput.value.toLowerCase();
    posts.forEach(p => {
      p.style.display = p.textContent.toLowerCase().includes(q) ? "" : "none";
    });
  });

  // Ctrl + K shortcut
  document.addEventListener("keydown", (e) => {
    if (e.ctrlKey && e.key.toLowerCase() === "k") {
      e.preventDefault();
      searchInput.focus();
    }
  });
</script>
{{ end }}
